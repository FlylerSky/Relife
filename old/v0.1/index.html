<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>One Social</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background:#f6f7fb; }
    .navbar { position:sticky; top:0; z-index:1000; }
    .search-box { flex:1; max-width:400px; }
    .search-results {
      display:none; position:absolute; top:100%; left:0; right:0;
      background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.1);
      max-height:300px; overflow-y:auto; z-index:2000; padding:10px;
    }
    .card-post { border-radius:14px; box-shadow:0 6px 18px rgba(17,24,39,.06); }
    .btn-rounded { border-radius:10px; }
    .hashtag { font-size:.85rem; color:#0d6efd; margin-right:6px; text-decoration:none; }
    .post-content { white-space: pre-wrap; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar bg-white shadow-sm py-2">
  <div class="container d-flex align-items-center justify-content-between position-relative">
    <div class="fw-bold">One Social</div>

    <!-- Search -->
    <div class="search-box position-relative mx-2 w-100">
      <input id="searchInput" class="form-control form-control-sm" placeholder="Tìm bài, người dùng, hashtag...">
      <div id="searchResults" class="search-results"></div>
    </div>

    <!-- Menu -->
    <button class="btn btn-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#menuCanvas">
      <i class="bi bi-list fs-4"></i>
    </button>
  </div>
</nav>

<!-- MENU -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="menuCanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-3">
      <i id="connIcon" class="bi bi-wifi text-success"></i>
      <span id="connText">Online</span>
    </div>
    <button class="btn btn-primary btn-rounded w-100" data-bs-toggle="modal" data-bs-target="#newPostModal">
      <i class="bi bi-plus-lg"></i> Đăng bài
    </button>
  </div>
</div>

<!-- FEED -->
<div class="container my-3">
  <div id="feed" class="d-grid gap-3"></div>
</div>

<!-- NEW POST MODAL -->
<div class="modal fade" id="newPostModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="newPostForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Viết bài mới</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="postDisplayName" class="form-control mb-2" placeholder="Tên hiển thị" required>
        <input id="postTitle" class="form-control mb-2" placeholder="Tiêu đề" required>
        <textarea id="postContent" class="form-control mb-2" rows="5" placeholder="Nội dung..."></textarea>
        <input id="postHashtags" class="form-control" placeholder="#hashtag, #khác">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-rounded" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-primary btn-rounded">Đăng</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- App -->
<script type="module">
  import { initFirebase } from './firebase-config.js';
  import {
    collection, query, orderBy, onSnapshot, addDoc, serverTimestamp,
    doc, updateDoc, increment, getDocs, where
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const db = initFirebase();
  const feed = document.getElementById('feed');
  const searchInput=document.getElementById('searchInput');
  const searchResults=document.getElementById('searchResults');

  function escapeHtml(str=''){return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function formatDate(ts){try{return ts.toDate().toLocaleString('vi-VN');}catch{return '';}}

  // Connection
  function updateConn(){
    const online=navigator.onLine;
    document.getElementById('connIcon').className=online?'bi bi-wifi text-success':'bi bi-wifi-off text-danger';
    document.getElementById('connText').textContent=online?'Online':'Offline';
  }
  window.addEventListener('online',updateConn);
  window.addEventListener('offline',updateConn);
  updateConn();

  // Feed
  onSnapshot(query(collection(db,'posts'),orderBy('createdAt','desc')), snap=>{
    feed.innerHTML='';
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const card=document.createElement('div');
      card.className='card card-post p-3';
      card.innerHTML=`
        <div class="fw-bold">${escapeHtml(d.displayName||'Ẩn danh')}</div>
        <div class="small text-muted">${escapeHtml(d.title||'')}</div>
        <div class="mt-2">${(d.hashtags||[]).map(h=>`<span class="hashtag">${h}</span>`).join(' ')}</div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-sm btn-outline-primary btn-rounded btn-like" data-id="${docSnap.id}">
            <i class="bi bi-hand-thumbs-up"></i> ${d.likes||0}
          </button>
          <button class="btn btn-sm btn-outline-danger btn-rounded btn-dislike" data-id="${docSnap.id}">
            <i class="bi bi-hand-thumbs-down"></i> ${d.dislikes||0}
          </button>
          <a href="post.html?id=${docSnap.id}" class="btn btn-sm btn-outline-success btn-rounded ms-auto">
            <i class="bi bi-box-arrow-up-right"></i> Xem
          </a>
        </div>`;
      feed.appendChild(card);
      card.querySelector('.btn-like').onclick=()=>updateDoc(doc(db,'posts',docSnap.id),{likes:increment(1)});
      card.querySelector('.btn-dislike').onclick=()=>updateDoc(doc(db,'posts',docSnap.id),{dislikes:increment(1)});
    });
  });

  // Đăng bài
  document.getElementById('newPostForm').onsubmit=async e=>{
    e.preventDefault();
    const displayName=document.getElementById('postDisplayName').value.trim();
    const title=document.getElementById('postTitle').value.trim();
    const content=document.getElementById('postContent').value.trim();
    const hashtags=document.getElementById('postHashtags').value.split(/[, ]+/).filter(Boolean);
    await addDoc(collection(db,'posts'),{
      displayName,title,content,hashtags,
      likes:0,dislikes:0,commentsCount:0,
      createdAt:serverTimestamp()
    });
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('newPostModal')).hide();
  };

  // Search
  searchInput.addEventListener('focus',()=>searchResults.style.display='block');
  document.addEventListener('click',e=>{
    if(!searchInput.contains(e.target)&&!searchResults.contains(e.target)){
      searchResults.style.display='none';
    }
  });
  searchInput.addEventListener('input',async()=>{
    const keyword=searchInput.value.trim().toLowerCase();
    if(!keyword){searchResults.innerHTML='';return;}
    let html='';
    // Tìm tiêu đề bài
    const posts=await getDocs(query(collection(db,'posts')));
    posts.forEach(p=>{
      const d=p.data();
      if((d.title||'').toLowerCase().includes(keyword) || (d.displayName||'').toLowerCase().includes(keyword) || (d.hashtags||[]).some(h=>h.toLowerCase().includes(keyword))){
        html+=`<div class="p-2 border-bottom"><a href="post.html?id=${p.id}" class="text-decoration-none">${escapeHtml(d.title||'(Không tiêu đề)')}</a> — <small>${escapeHtml(d.displayName||'Ẩn danh')}</small></div>`;
      }
    });
    searchResults.innerHTML=html||'<div class="p-2 text-muted">Không tìm thấy</div>';
  });
</script>
</body>
</html>
