<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One Social — Bài viết</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Quill CSS (giúp các class như ql-size-*, ql-font-* có style giống editor) -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <style>
    :root { --card-radius:14px; --shadow:0 6px 18px rgba(17,24,39,.06); }
    body { background:#f6f7fb; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container-main { max-width:920px; margin:20px auto; padding:0 12px; }
    .card-post { border-radius:var(--card-radius); padding:20px; box-shadow:var(--shadow); background:#fff; }
    .btn-rounded { border-radius:10px; }
    .small-muted { color:#6c757d; font-size:.9rem; }

    /* Make rich content responsive */
    .post-content img { max-width:100%; height:auto; display:block; margin:8px 0; border-radius:8px; }
    .post-content video { max-width:100%; height:auto; display:block; margin:8px 0; }
    .post-content iframe { display:block; margin:8px 0; max-width:100%; }
    .post-content table { border-collapse:collapse; width:100%; margin:8px 0; }
    .post-content th, .post-content td { border:1px solid #e6e6e6; padding:8px; text-align:left; }
    .table-wrapper { overflow-x:auto; }

    /* Quill size classes (match editor sizes) */
    .ql-size-small { font-size: 0.85rem; }
    .ql-size-large { font-size: 1.25rem; }
    .ql-size-huge { font-size: 1.5rem; }

    /* Quill font classes: map to sensible fallbacks.
       NOTE: if you use a custom Google Font (e.g. Roboto), include its <link> here too. */
    .ql-font-serif { font-family: Georgia, "Times New Roman", Times, serif; }
    .ql-font-monospace { font-family: Menlo, Monaco, "Courier New", monospace; }
    .ql-font-sans { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    /* common custom fonts mapping (you can add others) */
    .ql-font-roboto { font-family: "Roboto", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .ql-font-ubuntu { font-family: "Ubuntu", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* Code block */
    pre { background:#f8f9fa; padding:12px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }

    a.safe-link { color:#0d6efd; text-decoration:none; }

    /* small tweak for captions */
    figure { margin: 12px 0; }
    figcaption { font-size: .9rem; color: #6c757d; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container container-main">
    <a href="index.html" class="btn btn-link mb-3"><i class="bi bi-arrow-left"></i> Quay lại</a>

    <div id="postArea" class="card-post">
      <div id="loading" class="text-center py-5 text-muted">Đang tải...</div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <script type="module">
    import { initFirebase } from './firebase-config.js';
    import {
      doc, getDoc, updateDoc, increment, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const db = initFirebase();
    const params = new URLSearchParams(location.search);
    const postId = params.get('id');
    const postArea = document.getElementById('postArea');

    function formatDate(ts){
      try { return ts?.toDate ? ts.toDate().toLocaleString('vi-VN') : new Date().toLocaleString('vi-VN'); }
      catch(e){ return new Date().toLocaleString('vi-VN'); }
    }

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // -------------------------
    // Sanitization policy
    // -------------------------
    // Allowed iframe hosts (YouTube, Vimeo...). Add more if you trust them.
    const ALLOWED_IFRAME_HOSTS = ['www.youtube.com','youtube.com','www.youtube-nocookie.com','player.vimeo.com','vimeo.com'];

    // Allowed CSS properties (include font-family)
    const SAFE_CSS_PROPS = new Set([
      'color','background-color','font-size','font-weight','font-style','text-decoration',
      'text-align','width','height','max-width','min-width','margin','margin-left','margin-right',
      'padding','display','vertical-align','line-height','font-family'
    ]);

    // sanitize style string: keep only SAFE_CSS_PROPS and safe values
    function sanitizeStyleString(styleStr){
      if(!styleStr) return '';
      const parts = styleStr.split(';').map(p => p.trim()).filter(Boolean);
      const out = [];
      for(const part of parts){
        const [propRaw, ...valParts] = part.split(':');
        if(!propRaw || valParts.length===0) continue;
        const prop = propRaw.trim().toLowerCase();
        let val = valParts.join(':').trim();
        // block javascript: url(), expression() and data:text/html etc.
        if(/javascript:|expression\(|data:text\/html|data:text\/javascript/i.test(val)) continue;
        if(!SAFE_CSS_PROPS.has(prop)) continue;

        // For font-family: allow common characters, quotes, commas, hyphens
        if(prop === 'font-family'){
          // remove any url(...) parts if provided
          if(/url\s*\(/i.test(val)) continue;
          // allow only letters, numbers, spaces, commas, quotes, hyphen
          if(!/^[\s\w\-,\"']+$/i.test(val)) continue;
          // normalize quotes
          val = val.replace(/\s+/g,' ').trim();
          out.push(`${prop}: ${val}`);
          continue;
        }

        // For width/height: allow %, px, em, rem and calc() (basic)
        if((prop==='width' || prop==='height' || prop==='max-width' || prop==='min-width') && /^(?:\d+(\.\d+)?(px|em|rem|%)|calc\([^)]+\))$/i.test(val)){
          out.push(`${prop}: ${val}`);
          continue;
        }

        // For color properties: allow hex, rgb, rgba, color names
        if(prop.includes('color')){
          if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val) || /^rgba?\(/i.test(val) || /^[a-z\-]+$/i.test(val)){
            out.push(`${prop}: ${val}`);
            continue;
          } else {
            continue;
          }
        }

        // For numeric sizes and other safe props (allow px, em, rem)
        if(/^\d+(\.\d+)?(px|em|rem)?$/.test(val)){
          out.push(`${prop}: ${val}`);
          continue;
        }

        // Fallback: very conservative allow (reject complex/unrecognized)
      }
      return out.join('; ');
    }

    // DOMPurify config: allow extra tags/attrs used by Quill content
    const dpConfig = {
      ADD_TAGS: ['iframe','table','thead','tbody','tfoot','tr','td','th','colgroup','col','video','source','figure','figcaption','caption','pre'],
      ADD_ATTR: ['allow','allowfullscreen','frameborder','width','height','style','loading','referrerpolicy','sandbox','controls','playsinline','poster','alt','title'],
      KEEP_CONTENT: false
    };

    // Hook to sanitize attributes and enforce policies
    DOMPurify.addHook('afterSanitizeAttributes', function(node) {
      // Make links safe
      if(node.tagName === 'A'){
        node.setAttribute('target','_blank');
        node.setAttribute('rel','noopener noreferrer');
        node.classList.add('safe-link');
      }

      // Images: allow http/https/data:; lazy load; sanitize style
      if(node.tagName === 'IMG'){
        const src = node.getAttribute('src') || '';
        if(!(src.startsWith('http') || src.startsWith('data:'))){
          node.removeAttribute('src');
        } else {
          node.setAttribute('loading','lazy');
        }
        const style = node.getAttribute('style') || '';
        const safeStyle = sanitizeStyleString(style);
        node.setAttribute('style', (safeStyle? safeStyle + ';' : '') + 'max-width:100%;height:auto;display:block;');
      }

      // iframe: allow only from whitelisted hosts
      if(node.tagName === 'IFRAME'){
        const src = node.getAttribute('src') || '';
        try {
          const u = new URL(src, window.location.href);
          const host = u.host.toLowerCase();
          const allowed = ALLOWED_IFRAME_HOSTS.some(h => host.endsWith(h));
          if(!allowed){
            node.removeAttribute('src');
            node.parentNode && node.parentNode.removeChild(node);
            return;
          }
        } catch(e){
          node.removeAttribute('src');
          node.parentNode && node.parentNode.removeChild(node);
          return;
        }
        // sanitize style; allow percent widths
        const style = node.getAttribute('style') || '';
        const safeStyle = sanitizeStyleString(style);
        node.setAttribute('style', (safeStyle? safeStyle + ';' : '') + 'max-width:100%;display:block;margin:8px 0;');
        node.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        node.setAttribute('allowfullscreen','');
      }

      // video: ensure controls
      if(node.tagName === 'VIDEO'){
        node.setAttribute('controls','');
        const style = node.getAttribute('style') || '';
        const safeStyle = sanitizeStyleString(style);
        node.setAttribute('style', (safeStyle? safeStyle + ';' : '') + 'max-width:100%;height:auto;display:block;margin:8px 0;');
      }

      // Table: sanitize style
      if(node.tagName === 'TABLE' || node.tagName === 'TD' || node.tagName === 'TH'){
        const style = node.getAttribute('style') || '';
        const safeStyle = sanitizeStyleString(style);
        if(safeStyle) node.setAttribute('style', safeStyle);
        else node.removeAttribute('style');
      }

      // Global: sanitize style attribute for any element
      if(node.hasAttribute && node.hasAttribute('style')){
        const orig = node.getAttribute('style');
        const safe = sanitizeStyleString(orig);
        if(safe) node.setAttribute('style', safe);
        else node.removeAttribute('style');
      }
    });

    // sanitize function
    function sanitizeQuillHtml(html){
      if(!html) return '';
      return DOMPurify.sanitize(html, dpConfig);
    }

    // -------------------------
    // Render post
    // -------------------------
    async function loadPost(){
      if(!postId){
        postArea.innerHTML = '<div class="p-4 text-center text-muted">ID bài viết không hợp lệ. <a href="index.html">Về trang chính</a></div>';
        return;
      }

      const snap = await getDoc(doc(db, 'posts', postId));
      if(!snap.exists()){
        postArea.innerHTML = '<div class="p-4 text-center text-muted">Không tìm thấy bài viết.</div>';
        return;
      }
      const data = snap.data();

      const title = escapeHtml(data.title || '');
      const author = escapeHtml(data.displayName || 'Ẩn danh');
      const createdAt = formatDate(data.createdAt);
      const likes = data.likes || 0;
      const dislikes = data.dislikes || 0;
      const commentsCount = data.commentsCount || 0;
      const hashtags = (data.hashtags || []).map(h => `<a href="index.html?tag=${encodeURIComponent(h)}" class="small-muted text-decoration-none me-2">${escapeHtml(h)}</a>`).join(' ');

      let rawContent = data.content || '';
      // if starts with '<' assume HTML (Quill) else text
      let safeHtml = '';
      if(typeof rawContent === 'string' && rawContent.trim().startsWith('<')){
        safeHtml = sanitizeQuillHtml(rawContent);
      } else {
        safeHtml = '<div style="white-space:pre-wrap;">' + escapeHtml(rawContent) + '</div>';
      }

      postArea.innerHTML = `
        <div>
          <h4 style="margin-bottom:.15rem;">${title}</h4>
          <div class="small-muted mb-2">${author} • ${createdAt}</div>
          <hr>
        </div>

        <div id="postContentContainer" class="post-content mb-3">${safeHtml}</div>

        <div class="mb-3">${hashtags}</div>

        <div class="d-flex gap-2 align-items-center mb-3">
          <button id="likeBtn" class="btn btn-outline-primary btn-sm btn-rounded"><i class="bi bi-hand-thumbs-up"></i> <span id="likeCount">${likes}</span></button>
          <button id="dislikeBtn" class="btn btn-outline-danger btn-sm btn-rounded"><i class="bi bi-hand-thumbs-down"></i> <span id="dislikeCount">${dislikes}</span></button>
          <button id="commentToggle" class="btn btn-outline-secondary btn-sm btn-rounded ms-2"><i class="bi bi-chat"></i> <span id="commentCount">${commentsCount}</span></button>
          <button id="shareBtn" class="btn btn-outline-success btn-sm btn-rounded ms-auto"><i class="bi bi-share"></i> Chia sẻ</button>
        </div>

        <hr>

        <div id="commentsSection">
          <h6>Bình luận</h6>
          <div id="commentsList" class="mb-3"></div>
          <textarea id="commentText" class="form-control mb-2" rows="3" placeholder="Viết bình luận..."></textarea>
          <input id="commenterName" class="form-control mb-2" placeholder="Tên của bạn">
          <div class="d-flex gap-2">
            <button id="sendComment" class="btn btn-primary btn-rounded ms-auto">Gửi</button>
          </div>
        </div>
      `;

      // finalize content layout (wrap tables, adjust iframes)
      finalizeRenderedContent();
      bindActions();
      watchRealtime();
    }

    function finalizeRenderedContent(){
      const container = document.getElementById('postContentContainer');

      // wrap tables
      const tables = container.querySelectorAll('table');
      tables.forEach(tbl => {
        if(!tbl.parentElement.classList.contains('table-wrapper')){
          const wrapper = document.createElement('div');
          wrapper.className = 'table-wrapper';
          tbl.parentNode.insertBefore(wrapper, tbl);
          wrapper.appendChild(tbl);
        }
      });

      // adjust iframes (preserve % widths)
      const iframes = container.querySelectorAll('iframe');
      iframes.forEach(iframe => {
        const wAttr = iframe.getAttribute('width') || '';
        const styleWidth = iframe.style.width || '';
        if((wAttr && wAttr.trim().endsWith('%')) || (styleWidth && styleWidth.trim().endsWith('%'))){
          // keep percent width, but enforce max-width
          iframe.style.maxWidth = '100%';
        } else {
          iframe.style.width = iframe.style.width || '100%';
          iframe.style.maxWidth = '100%';
        }
        if(!iframe.style.height && !iframe.getAttribute('height')) iframe.style.height = '360px';
      });

      // ensure ql-font-* classes render (we defined mappings in CSS)
      // images: ensure alt existence
      container.querySelectorAll('img').forEach(img => { if(!img.alt) img.alt = 'image'; });
      // links: ensure safe attributes
      container.querySelectorAll('a').forEach(a => {
        if(!a.target) a.setAttribute('target','_blank');
        if(!a.rel) a.setAttribute('rel','noopener noreferrer');
      });
    }

    function bindActions(){
      const likeBtn = document.getElementById('likeBtn');
      const dislikeBtn = document.getElementById('dislikeBtn');
      const shareBtn = document.getElementById('shareBtn');
      const sendComment = document.getElementById('sendComment');
      const commentToggle = document.getElementById('commentToggle');

      likeBtn.addEventListener('click', async ()=>{
        if(localStorage.getItem('liked_'+postId)) return;
        localStorage.setItem('liked_'+postId,'1');
        await updateDoc(doc(db,'posts',postId), { likes: increment(1) });
      });

      dislikeBtn.addEventListener('click', async ()=>{
        if(localStorage.getItem('disliked_'+postId)) return;
        localStorage.setItem('disliked_'+postId,'1');
        await updateDoc(doc(db,'posts',postId), { dislikes: increment(1) });
      });

      shareBtn.addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(window.location.href);
          const old = shareBtn.innerHTML;
          shareBtn.innerHTML = '<i class="bi bi-check-lg"></i> Đã sao chép';
          setTimeout(()=> shareBtn.innerHTML = old, 1200);
        } catch(e){
          alert('Không thể sao chép URL — hãy sao chép thủ công.');
        }
      });

      sendComment.addEventListener('click', async ()=>{
        const name = document.getElementById('commenterName').value.trim() || 'Ẩn danh';
        const text = document.getElementById('commentText').value.trim();
        if(!text) return alert('Viết bình luận trước khi gửi.');
        await addDoc(collection(db,'posts',postId,'comments'), { displayName: name, text, createdAt: serverTimestamp() });
        await updateDoc(doc(db,'posts',postId), { commentsCount: increment(1) });
        document.getElementById('commentText').value = '';
      });

      commentToggle.addEventListener('click', ()=>{
        document.getElementById('commentsSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }

    function watchRealtime(){
      const commentsRef = collection(db, 'posts', postId, 'comments');
      const commentsQ = query(commentsRef, orderBy('createdAt','desc'));
      onSnapshot(commentsQ, (snap) => {
        const list = document.getElementById('commentsList');
        list.innerHTML = '';
        if(snap.empty){
          list.innerHTML = '<div class="text-muted">Chưa có bình luận nào.</div>';
          return;
        }
        snap.forEach(docSnap => {
          const c = docSnap.data();
          const wrapper = document.createElement('div');
          wrapper.className = 'mb-3';
          wrapper.innerHTML = `
            <div class="fw-bold">${escapeHtml(c.displayName||'Ẩn danh')}</div>
            <div class="small-muted mb-1">${formatDate(c.createdAt)}</div>
            <div style="white-space:pre-wrap;">${escapeHtml(c.text)}</div>
            <hr>
          `;
          list.appendChild(wrapper);
        });
      });

      const postRef = doc(db, 'posts', postId);
      onSnapshot(postRef, (snap) => {
        const d = snap.data();
        if(!d) return;
        document.getElementById('likeCount').textContent = d.likes || 0;
        document.getElementById('dislikeCount').textContent = d.dislikes || 0;
        document.getElementById('commentCount').textContent = d.commentsCount || 0;
      });
    }

    // Initialize
    (async ()=> {
      await loadPost();
    })();
  </script>
</body>
</html>
